{% extends 'home/base.html' %}

{% block title %} Flashcard Game {% endblock %}

{% block css %}
<style>
    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
  
    #start {
  
      display: block;
      margin: 16px auto;
    }
  
    .tile {
      width: 100px;
      height: 100px;
      background-color: lightblue;
      margin: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.5s ease;
      animation: introAnimation 2s ease forwards;
    }
  
  /*@keyframes introAnimation {
      from {
          transform: rotateY(0deg);
      }
      to {
          transform: rotateY(360deg);
      }
  }*/
  
  .tile > span {
      opacity: 0; /* Initially set opacity of text to 0 */
  }
  
  @keyframes fadeIn {
      from {
          opacity: 0; /* Start with opacity 0 */
      }
      to {
          opacity: 1; /* Increase opacity to 1 */
      }
  }
  
  .tile.flip {
    transform: rotateY(360deg); /* Rotate the tile to reveal its content */
  }
    
  </style>
{% endblock %}

{% block content%}

<div class="container py-3"></div>
<button id="start" class="btn btn-secondary">Start Game</button>
<input type="hidden" id="levelField" value=" {{ level }}">
<script>
document.addEventListener("DOMContentLoaded", function() {
  const all_tiles_obj = {'A':'a', 'B':'b', 'C':'c', 'D':'d', 'E':'e', 'F':'f', 'G':'g', 'H':'h', 'I':'i'};
  const tiles = [];
  no_of_cols = document.getElementById("levelField").value;
  no_of_rows = no_of_cols;
  if(no_of_rows%2 != 0){
    if(no_of_cols%2 != 0){
      no_of_rows--;
    }  
  } else if(no_of_cols%2 == 0 && no_of_rows!=2){
    no_of_rows--;
  }

  no_of_tiles = (no_of_cols*no_of_rows)/2
  keys = Object.keys(all_tiles_obj)
  shuffle(keys);
  for (let i = 0; i < no_of_tiles; i++) {
    const value = all_tiles_obj[keys[i]];
    tiles.push(keys[i]);
    tiles.push(value);
  }
  shuffle(tiles);  
  let selectedTiles = [];
  let matchedTiles = 0;

  const container = document.querySelector('.container');
  const startButton = document.getElementById('start');

  function shuffle(array) {
    let currentIndex = array.length;
    while (currentIndex != 0) {
      let randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;
      [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
  }

  function shuffleObject(obj) {
    // Get the keys of the object
    const keys = Object.keys(obj);

    // Shuffle the keys array
    let currentIndex = keys.length;
    while (currentIndex !== 0) {
        let randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [keys[currentIndex], keys[randomIndex]] = [keys[randomIndex], keys[currentIndex]];
    }

    // Construct a new object with shuffled keys and corresponding values
    const shuffledObj = {};
    for (const key of keys) {
        shuffledObj[key] = obj[key];
    }

    return shuffledObj;
}

  function createTiles() {
    for (let i = 0; i < tiles.length; i++) {
      if (i % no_of_rows === 0) {
        tilesContainer = document.createElement('div');
        tilesContainer.classList.add('row-container');
        container.appendChild(tilesContainer);
      }
      const tile = document.createElement('div');
      tile.classList.add('tile');
      tile.textContent = tiles[i]; // Initially show the content
      tile.dataset.index = i;
      tilesContainer.appendChild(tile);
      
    }
  }

  function resetGame() {
    selectedTiles = [];
    matchedTiles = 0;    
    const tileElements = document.querySelectorAll('.tile');
    tileElements.forEach(tile => {
      tile.textContent = '';
      //tile.classList.add('flip'); // Adds the 'flip' class to the tile element
      setTimeout(() => {
        tile.textContent = 'X'; // Changes the text content of the tile to 'X' after 10000 milliseconds (10 seconds)
      }, 100); // Timeout set to 10000 milliseconds (10 seconds)
    });
  }

  function isKeyValuePair(x, y, obj){
    if (x in obj && obj[x] === y) {
      return true;
    } else if (y in obj && obj[y] === x) {
      return true;
    } else {
      return false;
    }
  }

  function checkMatch() {
    if (selectedTiles.length === 2) {
      const [index1, index2] = selectedTiles;
      if (isKeyValuePair(tiles[index1], tiles[index2], all_tiles_obj)) {
        matchedTiles += 2;
        if (matchedTiles === tiles.length) {
          console.log('You win!');
        }
      } else {
        setTimeout(() => {
          const tileElements = document.querySelectorAll('.tile');   
          setTimeout(() => {
            tileElements[index2].textContent = '';
            tileElements[index1].textContent = '';
          }, 150);        
          tileElements[index1].classList.remove('flip'); 
          tileElements[index2].classList.remove('flip'); 
          setTimeout(() => {
            tileElements[index2].textContent = 'X';
            tileElements[index1].textContent = 'X';
          }, 150);
        }, 500);
      }
      selectedTiles = [];
    }
  }

  function handleTileClick(event) {
  const index = event.target.dataset.index;
  const tile = event.target;

  if (!selectedTiles.includes(index)) {
    selectedTiles.push(index);

    // Flip the tile by toggling the 'flip' class
    tile.classList.add('flip');

    tile.textContent = '';

    setTimeout(() => {
      tile.textContent = tiles[index]; // Show the content of the tile
    }, 150);

    checkMatch();
  }
}


  createTiles();

  startButton.addEventListener('click', function() {
    startButton.style.display = 'none';
    resetGame();
  });

  container.addEventListener('click', function(event) {
    if (event.target.classList.contains('tile')) {
      handleTileClick(event);
    }
  });
});
</script>

{% endblock %}